# Mavlink build and test configuration
version: 2.1
executors:
  circle-ci-mavlink-executor:
    docker:
      - image: 011301565624.dkr.ecr.us-east-1.amazonaws.com/matternet/mavnet-build-env:2.0
        aws_auth:
        # These are both environment variables in CircleCI and are generated by AWS
          aws_access_key_id: $ECR_AWS_ACCESS_KEY_ID
          aws_secret_access_key: $ECR_AWS_SECRET_ACCESS_KEY
        environment:
          PYTHONPATH: /mttr/mavlink
    working_directory: ~/mttr

jobs:
  build-mavlink:
    executor: circle-ci-mavlink-executor
    steps:
      - checkout
      - run: sudo apt-get install python3-pip && pip install --user future
      - run: git submodule update --init --recursive
      - run: mkdir build
      - run: cd build && cmake .. && make -j 4
      - persist_to_workspace:
          root: ~/mttr
          paths:
          - ./

workflows:
  version: 2
  main:
    jobs:
      - build-mavlink:
          context: mavnet
          filters:
            branches:
              only: /.*/
